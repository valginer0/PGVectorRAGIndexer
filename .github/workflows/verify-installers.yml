name: Verify Installers

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  verify-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Homebrew (ensure it's available)
        run: |
          if ! command -v brew &>/dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          
      - name: Verify macOS Installer (install.command)
        run: |
          echo "Simulating user running install.command..."
          
          # Since install.command downloads from GitHub release, for verification we want to test
          # the local version of installer.sh to catch bugs before release.
          # So we'll patch install.command for this test to use local installer.sh
          
          # Start a simpler test: run installer.sh directly as if downloaded
          INSTALL_DIR="$HOME/TestInstall"
          
          # Run installer in non-interactive mode using defaults
          # We use --dry-run first to check flags
          ./installer.sh --dry-run
          
          # Now run actual install
          # We pipe 'yes' to handle any prompts, though we improved automation
          # We add a timeout to prevent hanging
          ./installer.sh --install-dir "$INSTALL_DIR"
          
          # Verify installation
          if [ -d "$INSTALL_DIR/venv" ]; then
            echo "✅ Virtual environment created"
          else
            echo "❌ Virtual environment missing"
            exit 1
          fi
          
          if [ -f "$INSTALL_DIR/run_desktop_app.sh" ]; then
             echo "✅ App files present"
          else
             echo "❌ App files missing"
             exit 1
          fi

  verify-linux-ubuntu:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify Linux Installer (install-linux.sh)
        run: |
          echo "Testing on Ubuntu 24.04 (PEP 668 environment)..."
          
          INSTALL_DIR="$HOME/TestInstall"
          
          # Run installer
          # This tests the 'uv' path since this runner is Ubuntu 24.04
          ./installer.sh --install-dir "$INSTALL_DIR"
          
          # Verify
          if [ -d "$INSTALL_DIR/venv" ]; then
            echo "✅ Virtual environment created"
          else
             echo "❌ Virtual environment missing"
             # Debug info
             ls -la "$INSTALL_DIR" || true
             exit 1
          fi
          
          # Check if uv installed packages
          source "$INSTALL_DIR/venv/bin/activate"
          if pip show flask >/dev/null; then
             echo "✅ Dependencies installed"
          else
             echo "❌ Dependencies missing"
             exit 1
          fi

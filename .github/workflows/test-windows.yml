name: Windows Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Windows Unit Tests
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-asyncio
        pip install -r requirements.txt
        pip install -r requirements-desktop.txt

    - name: Run unit tests (no database)
      shell: bash
      env:
        QT_QPA_PLATFORM: minimal
      run: |
        pytest tests/ -v -m "not integration and not database and not slow and not ui" --tb=short \
          --ignore=tests/test_installer.py \
          --ignore=tests/test_split_deployment.py \
          --ignore=tests/test_web_ui.py \
          --ignore=tests/test_web_ui_integration.py \
          --ignore=tests/test_upload_endpoint.py \
          -k "not test_sets_permissions_on_linux and not test_secures_parent_directory and not test_system_open_linux_fallback and not test_resolve_path_mismatch_wsl and not test_resolves_simple_path and not test_remove_entry and not test_find_entry"

  msi-verify:
    name: MSI Install Verification
    runs-on: windows-latest
    needs: [ unit-tests ]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install PyInstaller
      run: pip install pyinstaller

    - name: Build installer
      working-directory: windows_installer
      run: |
        python -m PyInstaller --onedir --windowed --name "PGVectorRAGIndexer-Setup" --add-data "../VERSION;." --noupx --clean --noconfirm installer_gui.py

    - name: Add WiX to PATH
      run: echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $env:GITHUB_PATH

    - name: Build MSI
      run: |
        # Heat
        cd windows_installer
        heat dir dist/PGVectorRAGIndexer-Setup -dr INSTALLFOLDER -cg HarvestedComponents -gg -g1 -sf -srd -var "var.SourceDir" -t filter.xslt -out harvested.wxs
        cd ..
        # Candle
        $VER = Get-Content VERSION
        candle -arch x64 -dProductVersion="$VER" -ext WixUIExtension -ext WixUtilExtension -out windows_installer/project.wixobj windows_installer/project.wxs
        candle -arch x64 -dSourceDir="dist/PGVectorRAGIndexer-Setup" -ext WixUIExtension -ext WixUtilExtension -out windows_installer/harvested.wixobj windows_installer/harvested.wxs
        candle -arch x64 -ext WixUIExtension -ext WixUtilExtension -out windows_installer/ui.wixobj windows_installer/ui.wxs
        # Light
        light -out dist/PGVectorRAGIndexer.msi -ext WixUIExtension -ext WixUtilExtension -cultures:en-us -loc windows_installer/en-us.wxl -b dist/PGVectorRAGIndexer windows_installer/project.wixobj windows_installer/harvested.wixobj windows_installer/ui.wixobj

    - name: Verify MSI file exists
      run: |
        if (Test-Path "dist\PGVectorRAGIndexer.msi") {
          $size = (Get-Item "dist\PGVectorRAGIndexer.msi").Length / 1MB
          Write-Host "MSI file exists ($([math]::Round($size, 1)) MB)"
        } else {
          Write-Host "MSI file not found"
          exit 1
        }

    - name: Silent install MSI
      run: |
        $msiPath = Resolve-Path "dist\PGVectorRAGIndexer.msi"
        Write-Host "Installing from: $msiPath"
        $process = Start-Process msiexec -ArgumentList "/i `"$msiPath`" /quiet /norestart /l*v install.log" -Wait -PassThru
        Write-Host "MSI exit code: $($process.ExitCode)"
        if ($process.ExitCode -ne 0) {
          Write-Host "=== Install log (last 50 lines) ==="
          Get-Content install.log -Tail 50
          exit 1
        }

    - name: Verify installation
      run: |
        # Check install directory exists
        $installDir = "C:\Program Files\PGVectorRAGIndexer"
        if (Test-Path $installDir) {
          Write-Host "Install directory exists: $installDir"
          Get-ChildItem $installDir | Select-Object Name, Length | Format-Table
        } else {
          Write-Host "Install directory NOT found at $installDir"
          # Check common alternative locations
          Get-ChildItem "C:\Program Files" -Directory | Where-Object { $_.Name -like "*PGVector*" }
          exit 1
        }

        # Check main executable
        $exe = Join-Path $installDir "PGVectorRAGIndexer-Setup.exe"
        if (Test-Path $exe) {
          Write-Host "Executable found: $exe"
        } else {
          Write-Host "Executable NOT found at $exe"
          Get-ChildItem $installDir -Recurse -Filter "*.exe" | Select-Object FullName
          exit 1
        }

    - name: Silent uninstall MSI
      if: always()
      run: |
        $msiPath = Resolve-Path "dist\PGVectorRAGIndexer.msi" -ErrorAction SilentlyContinue
        if ($msiPath) {
          Start-Process msiexec -ArgumentList "/x `"$msiPath`" /quiet /norestart" -Wait
          Write-Host "Uninstall complete"
        }

  bootstrap-verify:
    name: Windows Bootstrap Script Verification
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Verify bootstrap_desktop_app.ps1 syntax
      run: |
        # Parse the script to check for syntax errors (don't execute)
        $null = [System.Management.Automation.PSParser]::Tokenize(
          (Get-Content bootstrap_desktop_app.ps1 -Raw), [ref]$null
        )
        Write-Host "bootstrap_desktop_app.ps1 syntax OK"

    - name: Test bootstrap with remote backend flag
      run: |
        # Run bootstrap in a way that tests the remote-backend path
        # (skips Docker, pre-seeds config)
        # We just verify the script starts and handles the flag without error
        # Use a timeout since we don't have a real server
        $env:PGVECTOR_SKIP_DOCKER = "1"
        Write-Host "Testing bootstrap_desktop_app.ps1 -RemoteBackend flag parsing..."
        # Verify the script defines the parameter
        $content = Get-Content bootstrap_desktop_app.ps1 -Raw
        if ($content -match 'RemoteBackend') {
          Write-Host "RemoteBackend parameter defined"
        } else {
          Write-Host "WARNING: RemoteBackend parameter not found"
        }
